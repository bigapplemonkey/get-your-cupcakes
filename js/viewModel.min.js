function sort(a,b){var c=1;["likes","rating"].indexOf(b)>-1&&(c*=-1),a&&b&&a.sort(function(a,d){return a[b]>d[b]?c:-c})}function whenAvailable(a,b){var c=10;window.setTimeout(function(){window[a]&&"undefined"!=typeof window[a]?b():window.setTimeout(arguments.callee,c)},c)}function initApp(a){a.initPlaces(),a.initComputed(),window.viewModel=a,view.init()}var ViewModel=function(){var a=this;a.initPlaces=function(){model.initialPlaces.forEach(function(b){a.initMarker(b)})},a.getInitialPlacesIDs=function(){var a=[];return model.initialPlaces.forEach(function(b){a.push(b.placeID)}),a},a.initMarker=function(b,c){var d=googleMap.createMarker(b,c);d.address=b.address,d.priceLevel=b.priceLevel?b.priceLevel:null,d.website=b.website,d.categories=b.categories?b.categories:null,d.placeID=b.placeID,d.photos=[],d.rating=0,d.likes=0,d.priceLevel="",d.comments=[],d.review="",d.wifi=!1,d.outdoorseating=!1,d.delivery=!1,d.creditcards=!1,d.formattedPhone="",d.phone="",d.facebook="",d.twitter="",a.retrieveDetails(d,function(){c?d.photos.length>0&&d.comments.length>0&&a.nearList.push(d):a.favoriteList.push(d)})},a.retrieveDetails=function(b,c){var d="https://api.foursquare.com/v2/venues/"+b.placeID;d+="?"+$.param({client_id:a.clientID,client_secret:a.clientSecret,v:a.version}),$.ajax({url:d,method:"GET",dataType:"json"}).done(function(d){b.rating=d.response.venue.rating?d.response.venue.rating:0,b.likes=d.response.venue.likes.count,b.formattedPhone=d.response.venue.contact.formattedPhone,b.phone=d.response.venue.contact.phone,d.response.venue.contact.facebook&&(b.facebook=d.response.venue.contact.facebook),d.response.venue.contact.twitter&&(b.twitter=d.response.venue.contact.twitter),d.response.venue.price&&(b.priceLevel=d.response.venue.price.message),d.response.venue.phrases&&(d.response.venue.phrases.forEach(function(a){b.comments.push('"'+a.sample.text+'"')}),b.review=b.comments[0].length<70?b.comments[0]:b.comments[0].substring(0,65)+'..."'),d.response.venue.attributes&&d.response.venue.attributes.groups.forEach(function(a){a.items.forEach(function(a){var c=a.displayName.replace(/\s+/g,"").replace("-","").toLowerCase();if(b.hasOwnProperty(c)){var d=a.displayValue.toLowerCase();(d.indexOf("yes")>=0||d.indexOf("delivery")>=0)&&(b[c]=!0)}})}),d.response.venue.photos.groups.length>0&&d.response.venue.photos.groups[0].items.forEach(function(a){b.photos.push(a.prefix+"500x500"+a.suffix)}),a.initializedMarkerCount++,a.placeCount&&a.placeCount===a.initializedMarkerCount&&(a.isDataReady(!0),a.errorMessage()||view.removeLoader()),c()}).fail(function(b){a.errorHandling("We're currently experiencing connectivity issues with Foursquare. Please try again later.")})},a.sortPlacesBy=function(b){a.sortBy(a.sortOptions[b])},a.addToFavorites=function(b){a.nearList.remove(b),googleMap.switchIcon(b,!0),a.favoriteList.push(b),a.savePlace(b),view.updateFavoriteCounter(b.title)},a.removeFromFavorites=function(b){a.favoriteList.remove(b),googleMap.switchIcon(b),a.nearList.push(b),a.removePlace(b.placeID),view.updateNearCounter(b.title)},a.savePlace=function(a){var b={placeID:a.placeID,address:a.address,name:a.title,photos:a.photos,point:{lat:a.getPosition().lat(),lng:a.getPosition().lng()},priceLevel:a.priceLevel?a.priceLevel:null,website:a.website?a.website:null};model.initialPlaces.push(b),localStorage.favoritePlaces=JSON.stringify(model)},a.removePlace=function(a){model.initialPlaces=$.grep(model.initialPlaces,function(b){return 0!==b.placeID.localeCompare(a)}),localStorage.favoritePlaces=JSON.stringify(model)},a.saveModel=function(){localStorage.favoritePlaces=JSON.stringify(model)},a.initViewElements=function(a){view.initCardElems(),googleMap.displayInfobox(a)},a.updateCenter=function(){model.position={center:googleMap.currentCenter.center,name:googleMap.currentCenter.name},model.initialPlaces=[],localStorage.favoritePlaces=JSON.stringify(model),googleMap.centerMap(googleMap.currentCenter.center),a.initApp(a)},a.keepCenter=function(){a.initApp(a)},a.showNotFound=function(){return a.searchString().length>0&&(a.isTab1Selected()?a.favoriteList().length>0&&0===a.filteredFavoriteList().length:a.nearList().length>0&&0===a.filteredNearList().length)},a.googleError=function(){a.errorHandling("We're currently experiencing connectivity issues with Google Map. Please try again later.")},a.errorHandling=function(b){a.errorMessage('<i class="material-icons error_icon">error_outline</i> '+b),view.stopLoader()},a.sortOptions=[{optionDisplay:"Name",optionValue:"title"},{optionDisplay:"Price&nbsp;&nbsp;&uarr;",optionValue:"priceLevel"},{optionDisplay:"Likes&nbsp;&nbsp;&darr;",optionValue:"likes"},{optionDisplay:"Rating&nbsp;&nbsp;&darr;",optionValue:"rating"}],a.clientID="RNGS24CFZIIKKPYYVPWTQSNTGQIBR5D3IV1MULITVHRT1RDE",a.clientSecret="D0YLUV1MSDS2NYGKCFJ332CFDOIDIYVRO1ERUS4S5UJF1GTJ",a.version="20130815",a.placeCount=0,a.initializedMarkerCount=0,a.errorMessage=ko.observable(""),a.searchString=ko.observable(""),a.sortBy=ko.observable(a.sortOptions[0]),a.isTab1Selected=ko.observable(!0),a.isDataReady=ko.observable(!1),a.favoriteList=ko.observableArray([]),a.nearList=ko.observableArray([]),a.filteredFavoriteList=ko.observableArray([]),a.filteredNearList=ko.observableArray([]),a.initComputed=function(){ko.computed(function(){var b=model.position.center.lat+","+model.position.center.lng,c=a.getInitialPlacesIDs(),d="https://api.foursquare.com/v2/venues/search";d+="?"+$.param({client_id:a.clientID,client_secret:a.clientSecret,v:a.version,ll:b,categoryId:"4bf58dd8d48988d1bc941735"}),$.ajax({url:d,method:"GET",dataType:"json"}).done(function(b){var d=0;b.response.venues.forEach(function(b){c.includes(b.id)||(a.initMarker({placeID:b.id,point:{lat:b.location.lat,lng:b.location.lng},name:b.name,address:[b.location.formattedAddress[0],b.location.formattedAddress[1]],website:b.url,categories:b.categories},!0),d++)}),a.placeCount=model.initialPlaces.length+d}).fail(function(b){a.errorHandling("We're currently experiencing connectivity issues with Foursquare. Please try again later.")})}),ko.computed(function(){var b=a.searchString().toLowerCase(),c=[],d=[],e=[],f=[];a.isTab1Selected()?b?(c=ko.utils.arrayFilter(a.favoriteList(),function(a){var c=a.title.toLowerCase().indexOf(b)>=0;return c||d.push(a),c}),sort(c,a.sortBy().optionValue),a.filteredFavoriteList(c),f=d.concat(a.filteredNearList()),e=c):(sort(a.favoriteList(),a.sortBy().optionValue),a.filteredFavoriteList(a.favoriteList()),f=a.filteredNearList(),e=a.filteredFavoriteList()):b?(c=ko.utils.arrayFilter(a.nearList(),function(a){var c=a.title.toLowerCase().indexOf(b)>=0;return c||d.push(a),a.title.toLowerCase().indexOf(b)>=0}),sort(c,a.sortBy().optionValue),a.filteredNearList(c),f=d.concat(a.filteredFavoriteList()),e=c):(sort(a.nearList(),a.sortBy().optionValue),a.filteredNearList(a.nearList()),f=a.filteredFavoriteList(),e=a.filteredNearList()),googleMap.displayMarkers(f,e)})}},viewModel=new ViewModel;ko.applyBindings(viewModel,document.getElementById("errorMessage")),whenAvailable("googleMap",function(){ko.applyBindings(viewModel),googleMap.currentCenter.inRatio?initApp(viewModel):(view.openModal(),viewModel.initApp=initApp)});